<!doctype html>
<html>
  <head>
    <link href="../../../stylesheets/all-bdf2e668.css" rel="stylesheet" type="text/css" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Blog Title - Delegation</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>

    <div id="main" role="main">
      <article>
          <h1>Delegation</h1>
        <p><a href="https://github.com/wykhuh">Wai-Yin</a> and I were thinking about implementing Stripe Webhooks in one of our projects to help us keep our records in sync when users preformed actions in the Stripe dashboard (e.g. deleting a credit card or refunding a charge).</p>

<p><a href="https://stripe.com/docs/webhooks">Stripe Webhooks</a> offers a choice of adding a new endpoint for each type of event you want to handle or sending all events to a single endpoint. We decided to go with a single endpoint. To make that happen it would be nice if there were someone who could take care of any kind of event, maybe <code>StripeEventManager</code> could do it?</p>

<p>This will involve handling multiple message types through the same interface using delegation and custom event classes.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Api</span>
  <span class="k">module</span> <span class="nn">Admins</span>
    <span class="k">class</span> <span class="nc">StripeHooksController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
      <span class="k">def</span> <span class="nf">create</span>
        <span class="n">event_manager</span> <span class="o">=</span> <span class="no">StripeEventManager</span><span class="p">.</span><span class="nf">new</span> <span class="n">stripe_payload</span>
        <span class="n">event_manager</span><span class="p">.</span><span class="nf">process_event</span>
        <span class="n">render</span> <span class="n">event_manager</span><span class="p">.</span><span class="nf">response_body</span><span class="p">,</span> <span class="ss">status: </span><span class="n">event_manager</span><span class="p">.</span><span class="nf">response_code</span>
      <span class="k">end</span>

      <span class="kp">private</span>

      <span class="k">def</span> <span class="nf">stripe_payload</span>
        <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Jim Gay has an interesting rant about the <a href="http://www.saturnflyer.com/blog/jim/2012/07/06/the-gang-of-four-is-wrong-and-you-dont-understand-delegation/">modern misconception of delegation</a>. TL;DR: what most people think of delegation is actually <em>message forwarding</em>. He goes on to explain that in true delegation <em>self</em> will always refer to the original message recipient:</p>

<blockquote>
<p>[W]hen you send a message to an object, it has a notion of “self” where it can find attributes and other methods. When that object delegates to another, then any reference to “self” always refers to the original message recipient. Always.</p>
</blockquote>

<p>Turns out we just need the fake kind of delegation that&#39;s provided by <a href="http://apidock.com/rails/v4.2.1/Module/delegate">Active Support</a></p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">StripeEventManager</span>
  <span class="kp">attr_accessor</span> <span class="ss">:request</span>
  <span class="n">delegate</span> <span class="ss">:process_event</span><span class="p">,</span> <span class="ss">:response_body</span><span class="p">,</span> <span class="ss">:response_code</span><span class="p">,</span> <span class="ss">to: :event_handler</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">event_handler</span>
    <span class="vi">@event_hander</span> <span class="o">||=</span> <span class="n">events_map</span><span class="p">[</span><span class="n">request</span><span class="p">[</span><span class="ss">:type</span><span class="p">]].</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">events_map</span>
    <span class="n">event_handlers</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="p">[</span><span class="n">klass</span><span class="p">.</span><span class="nf">event_name</span><span class="p">,</span> <span class="n">klass</span><span class="p">]</span> <span class="p">}.</span><span class="nf">to_h</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">event_handlers</span>
    <span class="no">StripeEvents</span><span class="p">.</span><span class="nf">constants</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="no">StripeEvents</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">c</span><span class="p">).</span><span class="nf">is_a?</span> <span class="no">Class</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>And heres an example of an event handler:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">StripeEvents</span>
  <span class="k">class</span> <span class="nc">CardDeleted</span>
    <span class="nc">EVENT_NAME</span> <span class="o">=</span> <span class="s1">'customer.card.deleted'</span>
    <span class="n">attr_accssor</span> <span class="ss">:request</span><span class="p">,</span> <span class="ss">:response_body</span><span class="p">,</span> <span class="ss">:response_code</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">event_name</span>
      <span class="no">EVENT_NAME</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="nb">fail</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s1">'bad Stripe request'</span> <span class="k">unless</span> <span class="n">valid_request</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">process_event</span>
      <span class="n">card</span> <span class="o">=</span> <span class="no">CreditCard</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">token: </span><span class="n">cart_token</span><span class="p">)</span>
      <span class="n">card</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">deleted_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span> <span class="k">if</span> <span class="n">card</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">response_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">valid_request</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:[]</span><span class="p">,</span> <span class="ss">:data</span><span class="p">).</span><span class="nf">try</span><span class="p">(</span><span class="ss">:[]</span><span class="p">,</span> <span class="ss">:object</span><span class="p">).</span><span class="nf">try</span><span class="p">(</span><span class="ss">:[]</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">cart_token</span>
      <span class="n">request</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:object</span><span class="p">][</span><span class="ss">:id</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

      </article>
    </div>

    <aside>
      <div class="line-behind-text"><h6 class="er_toc_tag" id="er-toc-id-1">Recent Articles</h6></div>
      <ol>
          <li><a href="../../07/29/delegating-concern.html">Delegating Concern</a> <span>Jul 29</span></li>
          <li><a href="../../07/07/validating-acyclic-graphs.html">Validating acyclic graphs</a> <span>Jul  7</span></li>
          <li><a href="../20/rails-broke-ngrok.html">Rails 4.2 broke Ngrok</a> <span>May 20</span></li>
          <li><a href="../18/virtual-inventory-location.html">Virtual Inventory Location</a> <span>May 18</span></li>
          <li><a href="../15/generic-devise-layout-lookup.html">Generic Devise Layout Lookup</a> <span>May 15</span></li>
          <li><a href="../13/broken-promises.html">Broken Promises</a> <span>May 13</span></li>
          <li><a href="../06/find-ifnone.html">Enumerable#find ifnone</a> <span>May  6</span></li>
          <li><a href="delegation.html">Delegation</a> <span>May  5</span></li>
          <li><a href="../04/class-extraction.html">Class Extraction</a> <span>May  4</span></li>
      </ol>
    </aside>
  </body>
</html>
