<!doctype html>
<html>
  <head>
    <link href="../../../stylesheets/all-bdf2e668.css" rel="stylesheet" type="text/css" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Blog Title - Enumerable#find ifnone</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>

    <div id="main" role="main">
      <article>
          <h1>Enumerable#find ifnone</h1>
        <p>I have a <code>WidgetKitManager</code> who needs to make sure that <code>WidgetKit</code>&#39;s have homogenous widget types. When adding a widget, it should either be added to a widget_kit with it&#39;s family or a new widget_kit should be created for it to live alone:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></td><td class="code"><pre>
<span class="n">describe</span> <span class="no">WidgetKitManager</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#widget_kit_for_new_widget'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns a widget_kit with the same type as the new widget'</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

      <span class="n">expected_widget_kit</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
        <span class="ss">:widget_kit</span><span class="p">,</span> <span class="ss">:with_complete_widgets</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span>
      <span class="p">)</span>

      <span class="n">new_widget</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span>
        <span class="ss">:widget</span><span class="p">,</span>
        <span class="ss">date_package: </span><span class="n">expected_widget_kit</span><span class="p">.</span><span class="nf">widgets</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">date_package</span>
      <span class="p">)</span>

      <span class="n">widget_kit_manager</span> <span class="o">=</span> <span class="no">WidgetKitManager</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">widget_kit_manager</span><span class="p">.</span><span class="nf">widget_kit_for_new_widget</span><span class="p">(</span><span class="n">new_widget</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">expected_widget_kit</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'creates a new widget_kit if no suitable widget_kit exists'</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">new_widget</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span>
        <span class="ss">:widget</span><span class="p">,</span> <span class="ss">:widget_with_required_associations</span>
      <span class="p">)</span>
      <span class="n">widget_kit_manager</span> <span class="o">=</span> <span class="no">WidgetKitManager</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">)</span>

      <span class="n">expect</span> <span class="p">{</span> <span class="n">widget_kit_manager</span><span class="p">.</span><span class="nf">widget_kit_for_new_widget</span><span class="p">(</span><span class="n">new_widget</span><span class="p">)</span>  <span class="p">}</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">widget_kits</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'adds the new widget to the widget_kit'</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">new_widget</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span>
        <span class="ss">:widget</span><span class="p">,</span> <span class="ss">:widget_with_required_associations</span>
      <span class="p">)</span>
      <span class="n">widget_kit_manager</span> <span class="o">=</span> <span class="no">WidgetKitManager</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">)</span>

      <span class="n">widget_kit</span> <span class="o">=</span> <span class="n">widget_kit_manager</span><span class="p">.</span><span class="nf">widget_kit_for_new_widget</span><span class="p">(</span><span class="n">new_widget</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">widget_kit</span><span class="p">.</span><span class="nf">widgets</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">new_widget</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></td></tr></tbody></table>
</div>

<p>When implementing <code>WidgetKitManager#widget_kit_for_new_widget</code> I noticed a nice feature in <code>Enumerable#find</code>, the optional <strong>ifnone</strong> argument:</p>

<p><em><code>find(ifnone = nil) { |obj| block } â†’ obj or nil</code></em></p>

<blockquote>
<p>Passes each entry in enum to block. Returns the first for which block is not false. If no object matches, calls ifnone and returns its result when it is specified, or returns nil otherwise.</p>
</blockquote>

<p>I don&#39;t know why, but until today my eyes just glossed over that little optional argument detail. Conveniently I noticed today and it was just what I needed! Look through a collection finding a match to some condition, if you don&#39;t find anything do some other business instead. Awesome:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">WidgetKitManager</span>
  <span class="kp">attr_accessor</span> <span class="ss">:current_user</span>

  <span class="n">delegate</span> <span class="ss">:widget_kits</span><span class="p">,</span> <span class="ss">to: :current_user</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">current_user</span> <span class="o">=</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">widget_kit_for_new_widget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
    <span class="n">found_kit</span> <span class="o">=</span>
      <span class="n">widget_kits</span><span class="p">.</span><span class="nf">detect</span><span class="p">(</span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">create_widget_kit</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">kit</span><span class="o">|</span>
        <span class="n">kit</span><span class="p">.</span><span class="nf">type_id</span> <span class="o">==</span> <span class="n">widget</span><span class="p">.</span><span class="nf">type_id</span>
      <span class="k">end</span>

    <span class="n">found_kit</span><span class="p">.</span><span class="nf">widgets</span> <span class="o">&lt;&lt;</span> <span class="n">widget</span>

    <span class="n">found_kit</span>
  <span class="k">end</span>

  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>

  <span class="nf">private</span>

  <span class="k">def</span> <span class="nf">create_widget_kit</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">widget_kits</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="ss">type_id: </span><span class="n">widget</span><span class="p">.</span><span class="nf">type_id</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

      </article>
    </div>

    <aside>
      <div class="line-behind-text"><h6 class="er_toc_tag" id="er-toc-id-1">Recent Articles</h6></div>
      <ol>
          <li><a href="../../07/29/delegating-concern.html">Delegating Concern</a> <span>Jul 29</span></li>
          <li><a href="../../07/07/validating-acyclic-graphs.html">Validating acyclic graphs</a> <span>Jul  7</span></li>
          <li><a href="../20/rails-broke-ngrok.html">Rails 4.2 broke Ngrok</a> <span>May 20</span></li>
          <li><a href="../18/virtual-inventory-location.html">Virtual Inventory Location</a> <span>May 18</span></li>
          <li><a href="../15/generic-devise-layout-lookup.html">Generic Devise Layout Lookup</a> <span>May 15</span></li>
          <li><a href="../13/broken-promises.html">Broken Promises</a> <span>May 13</span></li>
          <li><a href="find-ifnone.html">Enumerable#find ifnone</a> <span>May  6</span></li>
          <li><a href="../05/delegation.html">Delegation</a> <span>May  5</span></li>
          <li><a href="../04/class-extraction.html">Class Extraction</a> <span>May  4</span></li>
      </ol>
    </aside>
  </body>
</html>
