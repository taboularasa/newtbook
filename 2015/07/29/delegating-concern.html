<!doctype html>
<html>
  <head>
    <link href="../../../stylesheets/all-bdf2e668.css" rel="stylesheet" type="text/css" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Blog Title - Delegating Concern</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>

    <div id="main" role="main">
      <article>
          <h1>Delegating Concern</h1>
        <p>It&#39;s was the end of the quarter and we needed to build out some sweet reports to show off our awesome widget sales performance. There&#39;s going to be all kinds of charts and graphs going on. The good news is we get them all for <a href="http://www.chartjs.org/">free!</a> I only need to provide a suite of API endpoints for Chart.js to load the data from. Having a wide variety of charts and graphs is only part of the equation. If you&#39;re going gor <em>maximum</em> impact you&#39;re going to need some radical colors to fill up the page. So as you would expect Chart.js accepts colors as attributes of every datapoint. e.g.:</p>
<div class="highlight json"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="err">var</span><span class="w"> </span><span class="err">data</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">labels:</span><span class="w"> </span><span class="err">[</span><span class="nt">"January"</span><span class="err">,</span><span class="w"> </span><span class="nt">"February"</span><span class="err">,</span><span class="w"> </span><span class="nt">"March"</span><span class="err">,</span><span class="w"> </span><span class="nt">"April"</span><span class="err">,</span><span class="w"> </span><span class="nt">"May"</span><span class="err">,</span><span class="w"> </span><span class="nt">"June"</span><span class="err">,</span><span class="w"> </span><span class="nt">"July"</span><span class="err">],</span><span class="w">
  </span><span class="err">datasets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="err">label:</span><span class="w"> </span><span class="nt">"My First dataset"</span><span class="err">,</span><span class="w">
      </span><span class="err">fillColor</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(220,220,220,0.5)"</span><span class="p">,</span><span class="w">
      </span><span class="err">strokeColor</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(220,220,220,0.8)"</span><span class="p">,</span><span class="w">
      </span><span class="err">highlightFill</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(220,220,220,0.75)"</span><span class="p">,</span><span class="w">
      </span><span class="err">highlightStroke</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(220,220,220,1)"</span><span class="p">,</span><span class="w">
      </span><span class="err">data</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="err">label:</span><span class="w"> </span><span class="nt">"My Second dataset"</span><span class="err">,</span><span class="w">
      </span><span class="err">fillColor</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(151,187,205,0.5)"</span><span class="p">,</span><span class="w">
      </span><span class="err">strokeColor</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(151,187,205,0.8)"</span><span class="p">,</span><span class="w">
      </span><span class="err">highlightFill</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(151,187,205,0.75)"</span><span class="p">,</span><span class="w">
      </span><span class="err">highlightStroke</span><span class="p">:</span><span class="w"> </span><span class="s2">"rgba(151,187,205,1)"</span><span class="p">,</span><span class="w">
      </span><span class="err">data</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="err">;</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>

<p>Colors can be supplied in various formats but for my purposes <em>HSL</em> was going to work out best. See the number of datapoints for a given graph is going to be variable, but no matter what I want to have maximum differentation between each color. That makes graphs and charts easier to read and more colorful equals better!</p>

<p>And thats why I created <code>ColorSampler</code>, which works like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre> <span class="n">describe</span> <span class="no">ColorSampler</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'::hue_collection'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns an evenly stepped collection of hsb values'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">ColorSampler</span><span class="p">.</span><span class="nf">hue_collection</span><span class="p">(</span><span class="ss">quantity: </span><span class="mi">3</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'::hsl_collection'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns hsl values from a collection of hues'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">ColorSampler</span><span class="p">.</span><span class="nf">hsl_collection</span><span class="p">(</span><span class="ss">quantity: </span><span class="mi">3</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="s1">'hsl(0, 50%, 50%)'</span><span class="p">,</span>
          <span class="s1">'hsl(120, 50%, 50%)'</span><span class="p">,</span>
          <span class="s1">'hsl(240, 50%, 50%)'</span><span class="p">,</span>
          <span class="s1">'hsl(360, 50%, 50%)'</span>
        <span class="p">]</span>
      <span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'::adjust_hsl_lightness'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'adjusts the lightness of an hsl value'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">ColorSampler</span><span class="p">.</span><span class="nf">adjust_hsl_lightness</span><span class="p">(</span><span class="ss">hsl: </span><span class="s1">'hsl(0, 50%, 50%)'</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'hsl(0, 50%, 60%)'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'accepts a value to lighten by'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span>
        <span class="no">ColorSampler</span><span class="p">.</span><span class="nf">adjust_hsl_lightness</span><span class="p">(</span>
          <span class="ss">hsl: </span><span class="s1">'hsl(0, 50%, 50%)'</span><span class="p">,</span>
          <span class="ss">lightness: </span><span class="mi">25</span><span class="p">)</span>
        <span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'hsl(0, 50%, 25%)'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>I can pass in a quantity I want and get back an array of strings representing <em>HSL</em> colors. I can also get just the hue, or I can get a lighter version of an <em>HSL</em> color (which I need for the rollover states). Thanks to Ruby implementation is a snap:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ColorSampler</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hue_collection</span><span class="p">(</span><span class="n">quantity</span><span class="p">:)</span>
    <span class="n">full_range</span> <span class="o">=</span> <span class="mi">360</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">full_range</span> <span class="o">/</span> <span class="n">quantity</span>
    <span class="p">[].</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="n">full_range</span><span class="p">).</span><span class="nf">step</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">n</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hsl_collection</span><span class="p">(</span><span class="n">quantity</span><span class="p">:,</span> <span class="ss">saturation: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">lightness: </span><span class="mi">50</span><span class="p">)</span>
    <span class="n">hue_collection</span><span class="p">(</span><span class="ss">quantity: </span><span class="n">quantity</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">hue</span><span class="o">|</span>
      <span class="s2">"hsl(</span><span class="si">#{</span><span class="n">hue</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">saturation</span><span class="si">}</span><span class="s2">%, </span><span class="si">#{</span><span class="n">lightness</span><span class="si">}</span><span class="s2">%)"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">adjust_hsl_lightness</span><span class="p">(</span><span class="n">hsl</span><span class="p">:,</span> <span class="ss">lightness: </span><span class="mi">60</span><span class="p">)</span>
    <span class="n">hsl</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/\s\d+%\)/</span><span class="p">,</span> <span class="s2">" </span><span class="si">#{</span><span class="n">lightness</span><span class="si">}</span><span class="s2">%)"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Right about now you&#39;re thinking, &quot;Wait a minute, the title of this blog post was saying something about Delegating Concerns or some such nonsense but this guy just keeps talking about his silly color picking class. What the heck?&quot; If you are thinking something like that then fair enough. I guess I just like how that turned out. But wait, theres really a point to all this and here it is. Now that I have this nifty thing all setup, I need to hook it up with some collaborators and get some business done. And here is where the title of this post comes from.</p>

<p>The problem with Rails&#39; brand of concern is that their a pain in the butt to test. They need to be included in an instance of another class before they can do their thing so the test always reads with a fair bit of confusing indirection.</p>

<p>In this case the entire interface for <code>ColorSampler</code> is stateless and I find it annoying to have to be referencing the class constant or an instance method representing the class constant anytime I want to get at one of these methods. So in that respect what I really wanted was something that acted like a mixin or a concern.</p>

<p>I found a solution that gives the best of both worlds. It&#39;s as simple as this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">ColorSamplerDelegate</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">delegate</span> <span class="ss">:hsl_collection</span><span class="p">,</span> <span class="ss">:adjust_hsl_lightness</span><span class="p">,</span> <span class="ss">to: :ColorSampler</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Now when I include that in a collaborator I can reference the interface without having to reference the class constant.</p>

<p>And when I want to use it it would look like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">SalesOverview</span>
  <span class="k">class</span> <span class="nc">JSONFormatter</span>
    <span class="kp">include</span> <span class="no">ColorSamplerDelegate</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">sales_fields</span><span class="p">:,</span> <span class="n">widgets</span><span class="p">:)</span>
      <span class="vi">@sales_fields</span> <span class="o">=</span> <span class="n">sales_fields</span>
      <span class="vi">@widget_sales</span> <span class="o">=</span> <span class="n">widgets</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">payload</span>
      <span class="vi">@payload</span> <span class="o">||=</span> <span class="p">{</span>
        <span class="ss">data: </span><span class="p">{</span>
          <span class="ss">labels: </span><span class="vi">@sales_fields</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:titleize</span><span class="p">),</span>
          <span class="ss">datasets: </span><span class="vi">@widget_sales</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">data_set</span> <span class="n">e</span><span class="p">,</span> <span class="n">colors</span><span class="p">.</span><span class="nf">pop</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">data_length</span>
      <span class="vi">@widget_sales</span><span class="p">.</span><span class="nf">length</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="n">widget_sale</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="ss">label: </span><span class="n">widget_sale</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span>
        <span class="ss">fillColor: </span><span class="n">color</span><span class="p">,</span>
        <span class="ss">strokeColor: </span><span class="n">adjust_hsl_lightness</span><span class="p">(</span><span class="ss">hsl: </span><span class="n">color</span><span class="p">,</span> <span class="ss">lightness: </span><span class="mi">45</span><span class="p">),</span>
        <span class="ss">highlightFill: </span><span class="n">adjust_hsl_lightness</span><span class="p">(</span><span class="ss">hsl: </span><span class="n">color</span><span class="p">,</span> <span class="ss">lightness: </span><span class="mi">60</span><span class="p">),</span>
        <span class="ss">highlightStroke: </span><span class="n">adjust_hsl_lightness</span><span class="p">(</span><span class="ss">hsl: </span><span class="n">color</span><span class="p">,</span> <span class="ss">lightness: </span><span class="mi">55</span><span class="p">),</span>
        <span class="ss">data: </span><span class="n">data_points_for</span><span class="p">(</span><span class="ss">widget_sale: </span><span class="n">widget_sale</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">data_points_for</span><span class="p">(</span><span class="n">widget_sale</span><span class="p">:)</span>
      <span class="vi">@sales_fields</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">widget_sale</span><span class="p">.</span><span class="nf">grade</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">colors</span>
      <span class="vi">@colors</span> <span class="o">||=</span> <span class="n">hsl_collection</span><span class="p">(</span><span class="ss">quantity: </span><span class="n">data_length</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>As a bonus I can use it as a mechanism for limiting the surface area of the interface for specific context, say for example in another context I wanted to limit the interface to hues only, easy!</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">ColorSamplerDelegate::HueEdition</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">delegate</span> <span class="ss">:hue_collection</span><span class="p">,</span> <span class="ss">to: :ColorSampler</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Kind of reminds me of a protocol in Swift, only not as helpful.</p>

      </article>
    </div>

    <aside>
      <div class="line-behind-text"><h6 class="er_toc_tag" id="er-toc-id-1">Recent Articles</h6></div>
      <ol>
          <li><a href="delegating-concern.html">Delegating Concern</a> <span>Jul 29</span></li>
          <li><a href="../07/validating-acyclic-graphs.html">Validating acyclic graphs</a> <span>Jul  7</span></li>
          <li><a href="../../05/20/rails-broke-ngrok.html">Rails 4.2 broke Ngrok</a> <span>May 20</span></li>
          <li><a href="../../05/18/virtual-inventory-location.html">Virtual Inventory Location</a> <span>May 18</span></li>
          <li><a href="../../05/15/generic-devise-layout-lookup.html">Generic Devise Layout Lookup</a> <span>May 15</span></li>
          <li><a href="../../05/13/broken-promises.html">Broken Promises</a> <span>May 13</span></li>
          <li><a href="../../05/06/find-ifnone.html">Enumerable#find ifnone</a> <span>May  6</span></li>
          <li><a href="../../05/05/delegation.html">Delegation</a> <span>May  5</span></li>
          <li><a href="../../05/04/class-extraction.html">Class Extraction</a> <span>May  4</span></li>
      </ol>
    </aside>
  </body>
</html>
