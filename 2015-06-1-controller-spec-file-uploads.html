<!doctype html>
<html>
  <head>
    <link href="stylesheets/all-bdf2e668.css" rel="stylesheet" type="text/css" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Blog Title</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>

    <div id="main" role="main">
      <article>
        <p><a href="http://rspec.info/">RSpec</a> Controller Specs + <a href="https://github.com/carrierwaveuploader/carrierwave">Carrierwave</a> file uploads. Heres how to set it up.</p>

<p>Somewhere in your test suite setup you need to configure Carrierwave&#39;s root directory, disable processing and use <code>:file</code> for storage:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="no">CarrierWave</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">storage</span> <span class="o">=</span> <span class="ss">:file</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">root</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'tmp/uploads'</span><span class="p">)</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">enable_processing</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>You can use any directory for Carrierwave&#39;s root as long as Git ignores it.</p>

<p>Now we can write some controller specs. Lets say we&#39;re writing a form that edits a resource. The form includes a file picker thats hooked up to a Carrierwave uploader. From the perspective of the controller, we only care that the file got through. We could stub out the collaborators, but I found it simple enough to let everyone do their thing instead. In our context setup we can use <code>#fixture_file_upload</code> which is a shortcut for <code>ActionController::TestUploadedFile#new</code>. All we need is a path to a file. Heres what the context setup looks like all together:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:test_image_filename</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'widget.png'</span> <span class="p">}</span>
<span class="n">let</span><span class="p">(</span><span class="ss">:test_image_path</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"spec/support/fixtures/images/</span><span class="si">#{</span><span class="n">test_image_filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">let</span><span class="p">(</span><span class="ss">:expected_image</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">fixture_file_upload</span><span class="p">(</span><span class="n">test_image_path</span><span class="p">,</span> <span class="s1">'image/png'</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Now we have a file we can include in a params hash:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span>
    <span class="ss">id: </span><span class="n">widget</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
    <span class="ss">widget: </span><span class="p">{</span>
      <span class="ss">name: </span><span class="n">expected_widget_name</span><span class="p">,</span>
      <span class="ss">coordinator_id: </span><span class="n">new_coordinator</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
      <span class="ss">image: </span><span class="n">expected_image</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>And when we preform the request, everyone is happy!</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">it</span> <span class="s1">'updates the image'</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="n">params</span>

  <span class="n">expect</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">file</span><span class="p">.</span><span class="nf">original_filename</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">test_image_filename</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Thanks to <a href="https://github.com/jdwolk">jdwolk</a> for the tip.</p>

      </article>
    </div>

    <aside>
      <div class="line-behind-text"><h6 class="er_toc_tag" id="er-toc-id-1">Recent Articles</h6></div>
      <ol>
          <li><a href="2015/07/07/validating-acyclic-graphs.html">Validating acyclic graphs</a> <span>Jul  7</span></li>
          <li><a href="2015/05/20/rails-broke-ngrok.html">Rails 4.2 broke Ngrok</a> <span>May 20</span></li>
          <li><a href="2015/05/18/virtual-inventory-location.html">Virtual Inventory Location</a> <span>May 18</span></li>
          <li><a href="2015/05/15/generic-devise-layout-lookup.html">Generic Devise Layout Lookup</a> <span>May 15</span></li>
          <li><a href="2015/05/13/broken-promises.html">Broken Promises</a> <span>May 13</span></li>
          <li><a href="2015/05/06/find-ifnone.html">Enumerable#find ifnone</a> <span>May  6</span></li>
          <li><a href="2015/05/05/delegation.html">Delegation</a> <span>May  5</span></li>
          <li><a href="2015/05/04/class-extraction.html">Class Extraction</a> <span>May  4</span></li>
      </ol>
    </aside>
  </body>
</html>
